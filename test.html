<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover"/>
<meta name="description" content="A map integrating a GoJS Diagram and the Leaflet mapping library."/> 
<link rel="stylesheet" href="../assets/css/style.css"/> 
<!-- Copyright 1998-2022 by Northwoods Software Corporation. -->
<title>Leaflet.js and GoJS</title>
</head>

<body>
    <!-- * * * * * * * * * * * * * -->
    <!-- Start of GoJS sample code -->
    
    <script src="https://unpkg.com/gojs"></script>
    <div id="allSampleContent" class="p-4 w-full">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
    <style type="text/css">
    /* CSS applied to the Leaflet map */
      .mapDiagram {
        border: solid 1px black;
        width: 500px;
        height: 500px;
      }
      #myDiagramDiv {
        z-index: 701;
      }
    </style>

<script id="code">
function init() {
  if (window.goSamples) goSamples();  // init for these samples -- you don't need to call this

  /* Leaflet init */

  const defaultZoom = 6;
  const defaultOrigin = [50.02185841773444, 0.15380859375];

  myLeafletMap = L.map("map", {}).setView(defaultOrigin, defaultZoom);
  L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}", {
    attribution: '&copy; <a href="https://www.mapbox.com/about/maps/">Mapbox</a> &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    maxZoom: 18,
    minZoom: 2,
    tileSize: 512,
    zoomOffset: -1,
    id: "mapbox/streets-v11",
    accessToken: "pk.eyJ1IjoiZ29qcyIsImEiOiJjaXppcnNkbDgwMzQ3MnFsNDFnY2phb2QwIn0.7AuVKrWdxQnJxa_W7qC3-w"
  }).addTo(myLeafletMap);

  myLeafletMap.on("zoomend", updateNodes);
  myLeafletMap.on("move", updatePosition);
  myLeafletMap.on("moveend", updatePosition);

  let myUpdatingGoJS = false;  // prevent modifying data.latlong properties upon Leaflet "move" events
  function updateNodes() {  // called when zoom level has changed
    myUpdatingGoJS = true;
    myDiagram.commit(diag => {
      diag.nodes.each(n => n.updateTargetBindings("latlong")); // without virtualization this can be slow if there are many nodes
    }, null);
    myUpdatingGoJS = false;
  }
  function updatePosition() {  // called when map has been panned (i.e. top-left corner is at a different latlong)
    const mapb = myLeafletMap.getBounds();
    const pos = myLeafletMap.project([mapb.getNorth(), mapb.getWest()], myLeafletMap.getZoom());
    myDiagram.position = new go.Point(pos.x, pos.y);
  }

  /* GoJS init */

  // Since 2.2 you can also author concise templates with method chaining instead of GraphObject.make
  // For details, see https://gojs.net/latest/intro/buildingObjects.html
  const $ = go.GraphObject.make;
  myDiagram = $(go.Diagram, "myDiagramDiv",
    {
      "InitialLayoutCompleted": e => updatePosition(),
      "dragSelectingTool.isEnabled": false,
      "animationManager.isEnabled": false,
      scrollMode: go.Diagram.InfiniteScroll,
      allowZoom: false,
      allowHorizontalScroll: false,
      allowVerticalScroll: false,
      hasHorizontalScrollbar: false,
      hasVerticalScrollbar: false,
      padding: 0,
      defaultCursor: "default",
      "toolManager.hoverDelay": 100,  // how quickly tooltips are shown
      "undoManager.isEnabled": true,
      "ModelChanged": e => {
        if (e.change === go.ChangedEvent.Transaction &&
            (e.propertyName === "FinishedUndo" || e.propertyName === "FinishedRedo")) {
          setTimeout(() => updateNodes());
        }
      },
    });

  const toolTipTemplate =
    $("ToolTip",
      $(go.TextBlock, { margin: 4 },
        new go.Binding("text", "", d => d.key + "\nlocation: [" + d.latlong.join(", ") + "]"))
    );

  // the node template describes how each Node should be constructed
  myDiagram.nodeTemplate =
    $(go.Node, "Auto",
      { toolTip: toolTipTemplate, locationSpot: go.Spot.Center, cursor: "pointer" },
      $(go.Shape, "Circle",
        {
          fill: "rgba(0, 255, 0, .4)", stroke: "#082D47", strokeWidth: 1,
          width: 7, height: 7
        }),
      // A two-way data binding with an Array of latitude,longitude numbers.
      // We have to explicitly avoid updating the source data Array
      // when myUpdatingGoJS is true; otherwise there would be accumulating errors.
      new go.Binding("location", "latlong", data => {
        const pos = myLeafletMap.project(data, myLeafletMap.getZoom());
        return new go.Point(pos.x, pos.y);
      }).makeTwoWay((pt, data) => {
        if (myUpdatingGoJS) {
          return data.latlong; // no-op
        } else {
          const ll = myLeafletMap.unproject(L.point(pt.x, pt.y), myLeafletMap.getZoom());
          return [ll.lat, ll.lng];
        }
      })
    );

  myDiagram.linkTemplate =
    $(go.Link,
      { layerName: "Background", curve: go.Link.Bezier, curviness: 5 },
      $(go.Shape, { strokeWidth: 3, stroke: "rgba(100,100,255,.7)" })
    );

  // DraggingTool needs to disable panning of Leaflet map
  myDiagram.toolManager.draggingTool.doActivate = function() {
    myLeafletMap.dragging.disable();
    go.DraggingTool.prototype.doActivate.call(this);
  }

  myDiagram.toolManager.draggingTool.doDeactivate = function() {
    myLeafletMap.dragging.enable();
    go.DraggingTool.prototype.doDeactivate.call(this);
  }

  // create the model data that will be represented by Nodes and Links
  myDiagram.model = new go.GraphLinksModel(
    [
      // Abidjan Bus 10
      { key: "Gare Sud", latlong: [5.314696, -4.018542] },
      { key: "BAD", latlong: [5.322329, -4.015409] },
      { key: "Galerie des parques", latlong: [5.322885, -4.018848] },
      { key: "60 logement", latlong: [5.325144, -4.020076] },
      { key: "Cite financiere", latlong: [5.325144, -4.020076] },
      { key: "Gare Nord", latlong: [5.358606, -4.027452] },
    ],
    [
      { from: "Gare Sud", to: "Gare Nord" },
    ]);
} // end init
window.addEventListener('DOMContentLoaded', init);
</script>

<div id="sample">
  <div id="map" class="mapDiagram">
    <div id="myDiagramDiv" class="mapDiagram"></div>
  </div>  
</div>
    </div>
    <!-- * * * * * * * * * * * * * -->
    <!--  End of GoJS sample code  -->
  </div>
</body>
<!--  This script is part of the gojs.net website, and is not needed to run the sample -->
<script src="../assets/js/goSamples.js"></script>
</html>
